/**
 * Created by xiao on 2017/2/15.
 */
var min_width = 60;
var max_width = 280;
window.onload = function(){
    //阻止微信下拉
    function preventTouch() {
        event.preventDefault();
    }
    document.addEventListener('touchmove', preventTouch);

    var oTitle = document.getElementById("title");
    var oLogo = document.getElementById("logo");
    // 拖拽层级
    zIndex = 1;

    /*编辑框的出现*/
    $('.drag_pos').bind('touchstart',function(){
        $('.edit_box').hide();
        $('.rotate_el').hide();
        $(this).find('.edit_box').show();
        $(this).find('.rotate_el').show();
    });

    $('#title').bind('click',function(){
        $('#title').css("zIndex",120);
        $('.modify-options').css("zIndex",zIndex++);
        $('.modify-options').animate({
            bottom:'0'
        },800);
        txt_edit($('#title'));
        $('.modify-options li').find('button').bind('touchstart');
    });

    /*旋转*/
    var d = 0;
    var oDiv = document.getElementById("div1");
    var rotate_el = document.getElementById('rotate_el');
    scaleORrotate(oDiv,rotate_el);

    /*缩放*/
    var d1 = 0;
    var d2 = 1;
    var scaling_el = document.getElementById("scaling_el");
    var scaling_el1 = document.getElementById("scaling_ele");
    scaleORrotate(scaling_el,scaling_el1);

    //文字块修改背景和边框
    $('#div1').on("click",function(){
        changeWZ('.WZ_CHOOSE', '#div1');
    });
    $('#scaling_el').on("click",function(){
        changeWZ('.WZ_CHOOSE2', '#scaling_el');
    });

    /*拖拽*/
    drag(oTitle);
    drag(oLogo);
    drag(oDiv);
    drag(scaling_el);

    /*添加移除class*/
    $('.fontSize span').click(function () {
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
        $('#title span').css('fontSize',$(this).text());
        $(this).parents('li').find('i').text($(this).text());
    });

    /*底部三个按钮事件*/
    $('.bg_choose_btn').click(function () {
        $('.BG_CHOOSE').fadeIn();
        changeBgColor('.BG_CHOOSE');
    });
    $(".randomBg_btn").click(function() {
        var arr = ["#fff","#ccc","#eee","#ddd","red","#333"];
        $("body").css("background",arr[rnd(0,6)]);
    });

    // 设置事件监听器
    window.addEventListener("DOMContentLoaded", function() {
        // 获取元素
        var canvas = document.getElementById("canvas"),
            context = canvas.getContext("2d"),
            video = document.getElementById("video"),
            videoObj = { "video": true },
            errBack = function(error) {
                console.log("Video capture error: ", error.code);
            };

        // 设置video监听器
        if(navigator.getUserMedia) { // Standard
            navigator.getUserMedia(videoObj, function(stream) {
                video.src = stream;
                video.play();
            }, errBack);
        } else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
            navigator.webkitGetUserMedia(videoObj, function(stream){
                video.src = window.webkitURL.createObjectURL(stream);
                video.play();
            }, errBack);
        }
    }, false);

    var scaling_el_n1 = document.getElementById("rotate_el_n1");
    scaleORrotate(oTitle,scaling_el_n1);
    var scaling_el_n2 = document.getElementById("rotate_el_n2");
    scaleORrotate(oLogo,scaling_el_n2);
};

/*拖拽封装函数*/
function drag(oDiv){
    $(oDiv).on("touchstart",function(ev){
        var disX = ev.targetTouches[0].pageX - oDiv.offsetLeft;
        var disY = ev.targetTouches[0].pageY - oDiv.offsetTop;
        $(oDiv).css("zIndex",zIndex++);
        function fnMove(ev){
            //位置
            var l = ev.targetTouches[0].pageX - disX;
            var t = ev.targetTouches[0].pageY - disY;
            //位置限制
            if(t <= 4 ){
                t = 4;
            }
            if(t >= $(window).height() - $(oDiv).height()){
                t = $(window).height() - $(oDiv).height()
            }
            if(l <= 4){
                l = 4
            }
            if(l >= $(window).width() - $(oDiv).width()){
                l = $(window).width() - $(oDiv).width();
            }
            oDiv.style.left = l + "px";
            oDiv.style.top = t + "px";
        }
        function fnEnd(){
            //释放资源
            $(oDiv).off("touchmove",fnMove);
            $(oDiv).off("touchend",fnEnd);
        }

        $(oDiv).on("touchmove",fnMove);
        $(oDiv).on("touchend",fnEnd);

        //ev.preventDefault();
    });
}
//点击修改---出现选择框
function chang(obj) {
    obj.on("click",function(){
        console.log("111");
        if(obj.hasClass("border_add")) {
            obj.removeClass("border_add");
        }else{
            obj.addClass("border_add");
        }
    });
}
/*文字编辑封装函数*/
function txt_edit(obj){
    var border = obj.css("borderWidth");
    var fontSize = obj.find('.title_txt').css("fontSize");
    var color = '#000000';
    var content = '';
    //初始化
    var arr = [color,fontSize,border,content];
    $('.modify-options li span i').each(function (index) {
        $(this).html(arr[index]);
    });

    $(".content_inp").bind("input propertychange change", function (event) {
        if (event.type != "propertychange" || event.originalEvent.propertyName == "value") {
            $('.title_txt').text($(this).val());

            var signstr = $('#uid').val() + $(this).val() + '.00';
            // $("#pricesign").val(faultylabs.MD5(signstr));
        }

    });


    //修改字体颜色
    $('.modify-options li').eq(0).find('input').bind("change",function () {
        console.log($(this).val());
        $('.modify-options li span i').eq(0).html($(this).val());
        obj.css("color",$(this).val());
    });
    //修改边框
    $('.modify-options li').eq(2).find('button').bind("touchstart",function (ev) {
        event.stopPropagation();
        var type = $(this).html();
        var num = parseFloat($('.modify-options li span i').eq(2).html());
        if(type == "-"){
            if(num!=0){
                $('.modify-options li span i').eq(2).html(--num + "px");
            }
        }else{
            $('.modify-options li span i').eq(2).html(++num + "px");
        }
        obj.css("border",num+"px #000 solid");
        choiceSize(obj);
    });

    $('.sure_btn').on("touchstart",function () {
        $('.modify-options').animate({
            bottom:'-100%'
        },800);
        $('#title').css("zIndex",1);
        $('.modify-options li').find('button').unbind('touchstart');
    });
}

/*旋转封装函数*/
function a2d(n){
    return n*180/Math.PI;
}
function scaleORrotate(oDiv1,oDiv2){
    var d1 = 0;
    var d2 = 1;
    oDiv2.addEventListener("touchstart",function(ev){
        event.stopPropagation();
        var oldD = d1;
        var oldD2 = d2;
        var isSOR = 0;//判断是选择还是缩放
        var isFirstIn = true; //首次进入
        $('.edit_box').hide();
        $(this).prev().show();
        function getD(ev){
            var x1 = oDiv1.offsetLeft + oDiv1.offsetWidth/2;
            var y1 = oDiv1.offsetTop + oDiv1.offsetHeight/2;

            var x2 = ev.targetTouches[0].pageX;
            var y2 = ev.targetTouches[0].pageY;

            var x = x2 - x1;
            var y = y1 - y2;
            var z = a2d(Math.atan2(y,x));
            return {x:x,y:y,z:z};
        }

        var downD = getD(ev);

        function fnMove(ev){
            var a = downD.x - getD(ev).x;
            var b = downD.y - getD(ev).y;
            var c = Math.abs(Math.abs(a) - Math.abs(b));
            if(Math.abs(a) > 10 || Math.abs(b) > 10 ){
                if(isFirstIn){
                    if(c > 5){
                        isSOR = 1;//旋转
                    }else{
                        isSOR = 2;//缩放
                    }
                }
                isFirstIn = false;
            }


            d1 = (oldD + downD.z - getD(ev).z);

            //console.log(d1.toFixed(1))
            //d2 = oldD2 + (downD.y - getD(ev).y)/40;

             if(d1 <= 0 && d1 > -20){
                d2 = oldD2 - (downD.x - getD(ev).x)/40;
            }
            else if(d1 <= 20 && d1 > 0){
                d2 = oldD2 + (downD.y - getD(ev).y)/40;
            }

            if(d2 <= min_width / parseFloat(oDiv1.offsetWidth)){
                d2 = min_width / parseFloat(oDiv1.offsetWidth);
            }
            if(Math.abs(d2) >= max_width / parseFloat(oDiv1.offsetWidth)){
                d2 = max_width / parseFloat(oDiv1.offsetWidth);
            }
            oDiv1.style.transform = "rotate("+d1+"deg)" +"scale("+d2+")";
            oDiv1.setAttribute('d2_num',Math.round(d2*1000)/1000);
            console.log(oDiv1.getAttribute('d2_num'))
        }

        function fnEnd(){
            oDiv2.removeEventListener("touchmove",fnMove,false);
            oDiv2.removeEventListener("touchend",fnEnd,false);
        }
        oDiv2.addEventListener("touchmove",fnMove,false);
        oDiv2.addEventListener("touchend",fnEnd,false);
        ev.preventDefault();
    },false);
}
//切换背景色
function changeBgColor(obj){
    $(obj).css("zIndex","999");
    var INITBG = $("body").css("background");
    $(obj).find(".default_bg_div").removeClass("on");
    $(obj).find(".default_bg_div").each(function(){
        if(rgbToHex($(this).css("background")) == rgbToHex(INITBG)){
            $(this).addClass("on");
            return false;
        }
    });
    $(obj).find(".default_bg_div").on("click",clickDiv);

    function clickDiv(){
        if($(this).hasClass("on")){
            $(obj).find(".default_bg_div").removeClass("on");
            $("body").css("background",INITBG);
        }else{
            $(obj).find(".default_bg_div").removeClass("on");
            $(this).addClass("on");
            $("body").css("background",$(this).css("background"));
        }
    }

    $(obj).find(".close").on("click",function(){
        $(obj).fadeOut();
        $("body").css("background",INITBG);
        $(obj).find(".default_bg_div").off("click",clickDiv);

    });
    $(obj).find("button.sure_btn").on("click",function(){
        $(obj).fadeOut();
        $(obj).find(".default_bg_div").off("click",clickDiv);
    });
}
//随机数
function rnd(min,max){
    return min + Math.floor(Math.random() * (max -min));
}
//文字修改背景和边框
function changeWZ(obj,WZ){
    $(obj).fadeIn();
    $(obj).css("zIndex","999");
    var INITBG = $(WZ).css("background");
    $(obj).find(".default_bg_div").removeClass("on");
    $(obj).find(".default_bg_div").each(function(){
        if(rgbToHex($(this).css("background")) == rgbToHex(INITBG)){
            $(this).addClass("on");
            return false;
        }
    });

    $(obj).find(".default_bg_div").on("click",divClick);


    var BORDER_W = $(WZ).css("borderWidth");
    var BORDER_C = rgbToHex($(WZ).css("borderColor"));
    console.log(BORDER_C+"----"+BORDER_W);
    $(".WZ_border span i").text(parseInt(BORDER_W));
    $(".WZ_color p input").val(BORDER_C);
    $(".WZ_border button").on("click",bClick);

    $('.WZ_color p input').on("change",changeFn);

    function divClick(){
        if($(this).hasClass("on")){
            $(obj).find(".default_bg_div").removeClass("on");
            $(WZ).css("background",INITBG)
        }else{
            $(obj).find(".default_bg_div").removeClass("on");
            $(this).addClass("on");
            $(WZ).css("background",$(this).css("background"));
        }
    }

    function bClick(){
        var BW = parseInt($(".WZ_border span i").html());
        console.log("--->",BW)
        var TYPE = $(this).val();
        if(TYPE === "-"){
            if(BW <= 0){
                BW = 0;
            }else{
                BW -= 1;
            }
        }else if(TYPE ==="+"){
            BW = parseInt(BW) + 1;
        }
        $(".WZ_border span i").html(BW);
        $(WZ).css("border",BW + "px solid " + $('.WZ_color p input').val());
        choiceSize(WZ);
    }

    function changeFn(){
        $(WZ).css("border", parseInt($(".WZ_border span i").html())+ "px solid " +$(this).val());
        choiceSize(WZ);
    }
    

    $(obj).find(".close").on("click",function(){
        console.log(BORDER_W,"----",BORDER_C)
        $(WZ).css("border",parseInt(BORDER_W) + "px solid " + BORDER_C);
        $(WZ).css("background",INITBG);
        choiceSize(WZ);

        $(obj).fadeOut();
        $(obj).find(".default_bg_div").off("click",divClick);
        $(".WZ_border button").off("click",bClick);
        $('.WZ_color p input').off("change",changeFn);

    });

    $(obj).find("button.sure_btn").on("click",function(){
        $(obj).fadeOut();
        $(obj).find(".default_bg_div").off("click",divClick);
        $(".WZ_border button").off("click",bClick);

        $('.WZ_color p input').off("change",changeFn);
    });
}


//RGB转化成16进制 #
var rgbToHex = function(rgb) {
    // rgb(x, y, z)
    var color = rgb.toString().match(/\d+/g); // 把 x,y,z 推送到 color 数组里
    var hex = "#";
    for (var i = 0; i < 3; i++) {
        // 'Number.toString(16)' 是JS默认能实现转换成16进制数的方法.
        // 'color[i]' 是数组，要转换成字符串.
        // 如果结果是一位数，就在前面补零。例如： A变成0A
        hex += ("0" + Number(color[i]).toString(16)).slice(-2);
    }
    return hex;
}
//修改选择框的大小
function choiceSize(obj){
    var w = parseInt($(obj).css("width"));
    var h = parseInt($(obj).css("height"));
    var b = parseInt($(obj).css("borderWidth"));
    console.log("--->",w+"H:",h+"B:",b)
    $(obj).find('.edit_box').css({
        width:( w + 2 * b )+ "px",
        height:( h + 2 * b ) + "px",
        top: -b -2 + "px",
        left: -b - 2 + "px"
    });
}











































